# Puppet Agent: Authentication, Certificates, Facter, Catalog, and Node Classification

## Puppet Agent Overview

The Puppet Agent is the component installed on each managed node.
Its job is to:

1. Authenticate with the Puppet Server
2. Send facts about the system
3. Request and receive a compiled catalog
4. Apply the catalog to enforce the desired state
5. Store state information locally

The following sections explain each step in detail.

---

# Authentication

Every Puppet Agent must **authenticate** with the Puppet Server before it can receive a catalog.

Authentication happens using **SSL certificates**.
The agent generates its own private key and a Certificate Signing Request (CSR).
The Puppet Server signs the CSR, and this becomes the trusted identity of the node.

Flow:

1. Agent generates CSR
2. Server review/signs CSR
3. Agent downloads certificate
4. Both sides trust each other for future runs

This prevents unauthorized or unknown nodes from receiving configurations.

---

# SSL Authentication (Puppet Certificates)

Puppet uses a full **Public Key Infrastructure (PKI)** for trust and encryption.

Key components:

* Agent private key
* Agent SSL certificate
* Puppet Server CA (Certificate Authority) certificate

The agent uses these certificates to:

* Authenticate itself
* Verify Puppet Server identity
* Encrypt communication

## Managing Certificates With `puppet cert` Command

From the Puppet Server (CA):

### List pending CSRs

```
puppetserver ca list
```

### Sign a certificate (allow the agent)

```
puppetserver ca sign --certname <agent-fqdn>
```

### Revoke a certificate

```
puppetserver ca revoke --certname <agent-fqdn>
```

### Clean (remove) a certificate

```
puppetserver ca clean --certname <agent-fqdn>
```

These commands are used when adding, removing, or rotating Puppet agents in the environment.

---

# State File

Each agent maintains a **state file** on the node:

```
/opt/puppetlabs/puppet/cache/state/state.yaml
```

This file stores:

* The last applied catalog checksum
* Resource states
* Metadata about the last run

Purpose:

* Helps Puppet decide whether resources are already in the desired state
* Supports idempotency
* Speeds up agent runs
* Allows Puppet to resume interrupted operations

You normally donâ€™t modify this file manually.

---

# Facter

**Facter** is a tool that collects system information (facts).

Examples of facts:

* `os`
* `hostname`
* `ipaddress`
* `memory`
* `uptime`
* `architecture`
* `ec2_metadata` (if in AWS)

To view all facts:

```
facter
```

To view a specific fact:

```
facter ipaddress
```

Custom facts can also be created inside modules under:

```
<module>/facts.d/      (external facts)
<module>/lib/facter/   (Ruby custom facts)
```

Facts are crucial because they are sent to the Puppet Server and used in classification and catalog compilation.

---

# Catalog

A **catalog** is the final document that contains:

* All resources
* Their desired states
* Dependency relationships
* OS-specific provider selections

The Puppet Server compiles the catalog using:

* Manifests
* Modules
* Facts
* ENC (if used)
* Hiera data

You can inspect a catalog on an agent:

```
puppet agent --test --noop --debug
```

A catalog ensures agents perform the *exact* same steps every run.

---

# Node Classification (ENC)

Classification determines **which classes** should be applied to which nodes.

Three common methods:

## 1. Site.pp Classification

Using node definitions in `site.pp`:

```
node 'web01.example.com' {
  include app_nginx
}
```

## 2. Hiera Classification

Using hiera data to declare classes:

```
classes:
  - app_nginx
  - app_nmap
```

## 3. ENC (External Node Classifier)

An ENC is an external script or system that returns YAML with classes.

Puppet calls the ENC with the agent hostname.
The ENC responds with:

```yaml
classes:
  app_nginx:
    port: 8080
parameters:
  env: production
```

Popular ENCs:

* Foreman
* Puppet Enterprise Console
* Custom Python/Ruby scripts

---

# Manifest File (site.pp)

The **site.pp** file is the entry point for the environment.

Location:

```
/etc/puppetlabs/code/environments/production/manifests/site.pp
```

Purpose:

* Define node-specific behavior
* Include global classes
* Configure roles/profiles
* Set up node classification (if not using ENC/Hiera)

Example:

```puppet
node default {
  include base_config
}

node 'web01' {
  include app_nginx
}
```

---

# Node Definition

A Node Definition is a Puppet DSL block that matches agents by name or regex.

Example:

```puppet
node 'db01.example.com' {
  include app_mysql
}
```

Matching multiple nodes:

```
node /^web\d+\.example\.com$/ {
  include app_nginx
}
```

Fallback for all nodes:

```
node default {
  include base_config
}
```

Node definitions allow site.pp to act as a basic classification system.

---

# How Puppet Agent Workflow Looks End-to-End

1. Agent starts a run
2. Authenticates using SSL certificates
3. Sends facts (from Facter)
4. Server determines node classification (site.pp / Hiera / ENC)
5. Server compiles a catalog
6. Agent downloads and applies catalog
7. Agent updates state file
8. Reports back to the server

This is the lifecycle of every Puppet Agent communication.